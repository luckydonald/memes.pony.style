// Generated by CoffeeScript 1.9.1
window.SingleView = Backbone.View.extend({
  el: "#content",
  initialize: function(options) {
    this.template = tpl.get('single');
    this.model.on("change", (function(_this) {
      return function() {
        return _this.render();
      };
    })(this));
    if (this.model.isNew() && !options.firstLoad) {
      this.model.fetch();
    }
    $(window).scrollTop(0);
    KeyboardJS.on('r', (function(_this) {
      return function(event) {
        return _this.random(event);
      };
    })(this));
    KeyboardJS.on('left', (function(_this) {
      return function(event) {
        return _this.previous(event);
      };
    })(this));
    KeyboardJS.on('right', (function(_this) {
      return function(event) {
        return _this.next(event);
      };
    })(this));
    KeyboardJS.on('h', (function(_this) {
      return function(event) {
        return _this.previous(event);
      };
    })(this));
    KeyboardJS.on('l', (function(_this) {
      return function(event) {
        return _this.next(event);
      };
    })(this));
    KeyboardJS.on('esc', (function(_this) {
      return function(event) {
        return _this.cancel(event);
      };
    })(this));
    return this.updateUsername();
  },
  events: {
    "click .tag": "navigateAnchor",
    "focus #controls div": "activate",
    "blur #controls div": "deactivate",
    "click #editbutton": "editInfo",
    "click .window .close": "cancel",
    "click #mask": "cancel",
    "click #single": "random",
    "click .window .report": "report",
    "submit #info-edit form": "saveInfo",
    "click #flag": "showWindow",
    "keydown input": "disableShortcuts",
    "keyup input": "disableShortcuts",
    "keydown textarea": "disableShortcuts",
    "keyup textarea": "disableShortcuts",
    "submit #comments form": "comment"
  },
  beforeClose: function() {
    this.model.off("change");
    KeyboardJS.clear('r');
    KeyboardJS.clear('left');
    KeyboardJS.clear('right');
    KeyboardJS.clear('h');
    KeyboardJS.clear('l');
    return KeyboardJS.clear('esc');
  },
  render: function() {
    var current_scroll, face, i, image, len, ref, resizes, size, thumb, to_template;
    if (!this.model.isNew()) {
      $("#loader").hide();
      current_scroll = $(window).scrollTop();
      face = this.model.toJSON();
      image = this.model.getImage();
      thumb = this.model.getThumb(false, true);
      resizes = [];
      ref = ["huge", "large", "medium", "small"];
      for (i = 0, len = ref.length; i < len; i++) {
        size = ref[i];
        if (face.resizes[size]) {
          resizes.push({
            size: size,
            image: face.resizes[size]
          });
        }
      }
      face.resizes = resizes;
      this.updateMeta(face);
      this.updateUsername();
      to_template = {
        face: face,
        image: image,
        static_prefix: static_prefix,
        thumb: thumb,
        image_service: app.getImageService()
      };
      this.$el.html(Mustache.render(this.template, to_template));
      $(".single").css("max-height", screen.height);
      setTimeout(function() {
        return $(window).scrollTop(current_scroll);
      }, 300);
    }
    return this;
  },
  updateMeta: function(face) {
    var canonical, image_src;
    $("title").html(face.title + " - MyLittleFaceWhen");
    $("meta[name=description]").attr("content", face.description);
    $("#og-image").attr("content", face.image);
    if ($("#cd-layout") === []) {
      $("head").append("<meta id='#cd-layout' poperty='cd:layout' content='banner'>");
    }
    image_src = $("link[rel=image_src]");
    if (image_src === []) {
      $("head").append("<link rel='image_src' href='" + face.image + "'>");
    } else {
      image_src.attr("href", face.image);
    }
    canonical = $("link[rel=canonical]");
    if (canonical === []) {
      return $("head").append("<link rel='canonical' href='http://mylittlefacewhen.com/f/" + face.id + "/'>");
    } else {
      return canonical.attr("href", "http://mylittlefacewhen.com/f/" + face.id + "/");
    }
  },
  activate: function(event) {
    return $(event.currentTarget).addClass("activated");
  },
  cancel: function(event) {
    event.preventDefault();
    return $("#mask, .window").fadeOut("fast");
  },
  deactivate: function(event) {
    return $(event.currentTarget).removeClass("activated");
  },
  editInfo: function(event) {
    this.$el.find("#info-show").hide();
    this.$el.find("#info-edit").show();
    return $(document).scrollTop($(document).height());
  },
  random: function(event) {
    event.preventDefault();
    this.undelegateEvents();
    this.$el.html("<div id='loader'><img src='/static/dash.gif' /></div>");
    $("#loader").show();
    return app.random();
  },
  report: function(event) {
    var data, reason;
    event.preventDefault();
    reason = $(".window textarea").val().replace(/\n/g, "\\n");
    if (!reason) {
      return;
    }
    console.log(this.model);
    data = JSON.stringify({
      reason: reason,
      face: "/api/v3/face/" + (this.model.get("id")) + "/"
    });
    this.undelegateEvents();
    return $.ajax({
      type: "POST",
      url: "/api/v3/flag/",
      contentType: "application/json; charset=utf-8",
      data: data,
      processData: false,
      success: function() {
        return app.navigate("/f/1221/", true);
      },
      error: function() {
        var info;
        info = $(".window h2");
        info.css("color", "black").css("background-color", "red");
        return info.html("An error has ocurred with this report !");
      }
    });
  },
  saveInfo: function(event) {
    var save;
    event.preventDefault();
    $("#loader").show();
    this.$el.find("#info-edit").hide();
    save = (function(_this) {
      return function() {
        return _this.model.save({
          tags: event.currentTarget[0].value,
          source: event.currentTarget[1].value
        }, {
          wait: true
        });
      };
    })(this);
    if (this.model.isNew()) {
      return this.model.fetch({
        success: (function(_this) {
          return function() {
            return save();
          };
        })(this)
      });
    } else {
      return save();
    }
  },
  showWindow: function(event) {
    var id, winH, winW;
    id = "#dialog";
    winH = $(window).height();
    winW = $(window).width();
    $("#mask").css({
      width: winW,
      height: winH
    }).fadeIn("fast");
    return $(id).css({
      top: winH / 3,
      left: winW / 2 - $(id).width() / 2
    }).fadeIn("fast");
  },
  previous: function(event) {
    return this.gotoDir(event, "-id", "lt");
  },
  next: function(event) {
    return this.gotoDir(event, "id", "gt");
  },
  gotoDir: function(event, order, dir) {
    var col, params;
    col = new FaceCollection();
    params = {
      order_by: order,
      limit: 1,
      accepted: true,
      removed: false
    };
    params["id__" + dir] = this.model.get("id");
    return col.fetch({
      data: params,
      success: (function(_this) {
        return function(data) {
          if (!(col.length > 0)) {
            return void 0;
          }
          return app.navigate("f/" + (col.models[0].get("id")) + "/", {
            trigger: true
          });
        };
      })(this)
    });
  },
  disableShortcuts: function(event) {
    return event.stopPropagation();
  },
  comment: function(event) {
    var comment, data;
    event.preventDefault();
    data = {};
    _.each($(event.target).serializeArray(), function(input) {
      return data[input.name] = input.value;
    });
    localStorage.setItem("username", data["username"]);
    comment = new Comment(data);
    comment.save(null, {
      success: (function(_this) {
        return function(model, response, options) {
          return window.location.reload();
        };
      })(this)
    });
    return console.log(data);
  },
  updateUsername: function() {
    var username;
    username = localStorage.getItem("username");
    if (username) {
      return this.$el.find("#comments input[name=username]").val(username);
    }
  }
});
